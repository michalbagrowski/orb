parameters:
  plans_workspace:
    type: string
    default: /tmp/plans
  path:
    type: string
    default: "/tmp/plans/plan.out"
  auto_approve:
    type: boolean
    default: false
  parallelism:
    type: integer
    default: 20
  lock_timeout:
    type: string
    default: "5m"
steps:
  - attach_workspace:
      at: << parameters.plans_workspace >>
  - run:
      name: Terraform apply
      command: |
        TF_ARGS=""
        if [ "<< parameters.auto_approve >>" = "true" ]; then
            TF_ARGS="$TF_ARGS -auto-approve"
        fi
        envdir /secrets terraform apply << parameters.path >> \
          -lock-timeout=<< parameters.lock_timeout >> \
          -parallelism=<< parameters.parallelism >> \
          $TF_ARGS
